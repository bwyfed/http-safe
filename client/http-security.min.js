"use strict";!function(e){function t(e){var t={};(t=e).ua=navigator.userAgent;var n=new XMLHttpRequest;n.open("POST",b),n.setRequestHeader("Content-Type","application/json"),n.send(JSON.stringify(t))}function n(e,t){if(!t||-1!==t.indexOf("http-security.js"))return!0;for(var n=e.length,a=0;a<n;a++)if(new RegExp(e[a]).test(t.replace("https://","").replace("http://","")))return!0;return!1}function a(e){for(var t=document.all,n=0;n<t.length;n++)i(t[n])}function i(e){function a(a,i){i=2===i.length?i[1]:"","A"===a?n(I,i)&&(e.href="javascript:void(0)",console.log("拦截A的内联可疑脚本:"+i),t({url:window.location.href,eventName:"interception inline script--anchor tag",eventId:10004,tagName:e.tagName,attrValue:i})):"IFRAME"===a&&n(M,i)&&(e.src="javascript:void(0)",console.log("拦截IFRAME可疑事件:"+i),t({url:window.location.href,eventName:"interception inline script--iframe tag",eventId:10004,tagName:e.tagName,attrValue:i}))}var i,o,r,c=e.attributes;for(var l in c)if(c.hasOwnProperty(l)&&(i=c[l],o=i.name,r=i.value,0===o.indexOf("on")&&n(M,r)&&(e[o]=null,console.log("拦截可疑内联事件:"+r),t({url:window.location.href,eventName:"interception inline event",eventId:10003,tagName:e.tagName,onName:o})),"A"===e.tagName||"IFRAME"===e.tagName)){var s=new RegExp("javascript:(.*)");"A"===e.tagName&&"href"===o&&"javascript:"===e.protocol?(r=e.href.match(s),a(e.tagName,r)):"IFRAME"===e.tagName&&"src"===o&&-1!==e.src.indexOf("javascript:")&&(r=e.src.match(s),a(e.tagName,r))}}function o(){var e,a=document.getElementsByTagName("script");console.log("scan static script=====start");for(var i=0;i<a.length;i++)e=a[i],console.log(e.src),n(w,e.src)||(console.log("发现可疑静态脚本:",e.src),t({url:window.location.href,eventName:"monitor static script",eventId:10005,tagName:e.tagName,attrValue:e.src}),e.parentNode&&e.parentNode.removeChild(e));console.log("scan static script=====end")}function r(){var a=e.MutationObserver||e.WebKitMutationObserver||e.MozMutationObserver;a&&(y=new a(function(e){console.log("MutationObserver event***********begin"),e.forEach(function(e){for(var a=e.addedNodes,i=0;i<a.length;i++){var o=a[i];console.log(o.tagName),"SCRIPT"!==o.tagName&&"IFRAME"!==o.tagName||("IFRAME"===o.tagName&&o.src&&!n(w,o.src)?(o.parentNode&&o.parentNode.removeChild(o),console.log("拦截到可疑iframe",o.src)):o.src&&(n(w,o.src)||(t({url:window.location.href,eventName:"interception static script",eventId:10005,tagName:o.tagName,attrValue:o.src}),o.parentNode&&o.parentNode.removeChild(o),console.log("拦截可疑静态脚本:",o.src))))}}),console.log("MutationObserver event***********end")})).observe(document,{subtree:!0,childList:!0})}function c(e){o(),r(),e&&"function"==typeof e&&e()}function l(e){console.log("进入异步的动态脚本监控阶段======"),window.onload=function(){y&&y.disconnect()},document.addEventListener("DOMNodeInserted",function(e){console.log(e.type);var a=e.target;n(w,a.src)||(console.log("监控到动态创建节点："+a.nodeName+",id为："+(a.id?a.id:"")),t({url:window.location.href,eventName:"monitor dynamic script",eventId:10006,tagName:a.tagName,attrValue:a.src}),a.parentNode.removeChild(a))},!0),e&&"function"==typeof e&&e()}function s(e){var a=e.Element.prototype.setAttribute;e.Element.prototype.setAttribute=function(e,i){"SCRIPT"!==this.tagName&&"IFRAME"!==this.tagName||!/^src$/i.test(e)||n(w,i)?a.apply(this,arguments):"IFRAME"===this.tagName&&(this.style.display="none",t({url:window.location.href,eventName:"add iframe into page",eventId:10002,iframeUrl:i,topPageUrl:window.location.href}))}}function p(){for(var e,a,i=document.getElementsByTagName("iframe"),o=0;o<i.length;o++)e=i[o],console.log(e.src),(a=e.src)&&(n(w,a)||(e.parentNode&&e.parentNode.removeChild(e),t({url:window.location.href,eventName:"add iframe into page",eventId:10002,iframeUrl:a,topPageUrl:window.location.href})))}function u(t){d(e),t&&"function"==typeof t&&t()}function d(e){s(e),p(e);var t=e.MutationObserver||e.WebKitMutationObserver||e.MozMutationObserver;t&&new t(function(e){e.forEach(function(e){for(var t=e.addedNodes,n=0;n<t.length;n++){var a=t[n];"IFRAME"===a.tagName&&a.contentWindow&&d(a.contentWindow)}})}).observe(document,{subtree:!0,childList:!0})}function f(e){try{Object.defineProperty(Function.prototype,"call",{value:Function.prototype.call,writable:!1,configurable:!1,enumerable:!0}),Object.defineProperty(Function.prototype,"apply",{value:Function.prototype.apply,writable:!1,configurable:!1,enumerable:!0})}catch(e){}e&&"function"==typeof e&&e()}function g(e){var n="iframe_hijack_redirected";if(self!==top){for(var a=document.referrer,i=w.length,o=0;o<i;o++)if(new RegExp(w[o],"i").test(a))return;var r=location.href.split("#");location.search?r[0]+="&"+n+"=3":r[0]+="?"+n+"=3";try{top.location.href=r.join("#"),z.get("HtpLocTmp")||z.set("HtpLocTmp","1"),t({url:window.location.href,eventName:"page is embbed in iframe",eventId:10001,iframeUrl:"",topPageUrl:a})}catch(e){t({url:window.location.href,eventName:"page is embbed in iframe,redirect fail",eventId:10001,iframeUrl:"",topPageUrl:a})}e&&"function"==typeof e&&e()}}function m(e){var t=e.join("|");return[new RegExp("([a-zA-Z|a-zA-Z\\d])+(\\.)+("+t+")+(\\.)+[A-Za-z]{2,14}","i"),new RegExp("((https|http):\\/\\/)+([a-zA-Z|a-zA-Zd])+(\\.)+("+t+")+(\\.)+[A-Za-z]{2,14}","i"),new RegExp("([a-zA-Z|a-zA-Z\\d])+(.)+("+t+")+(:[0-9]{1,4})+(\\.)+[A-Za-z]{2,14}","i"),new RegExp("[a-zA-Z0-9]\\:\\/\\/[a-zA-Z0-9_/]*","i")]}function v(){h?axios.get(h).then(function(e){console.log(e.data),E=m(e.data)}):w&&(E=m(w)),R.iframeSrc&&g(R.iframeSrc[1]),R.iframe&&u(R.iframe[1]),R.inlineEvent&&A&&a(R.inlineEvent[1]),R.staticScript&&c(R.staticScript[1]),R.dynamicScript&&l(R.dynamicScript[1]),R.lockCallAndApply&&f(R.lockCallAndApply[1])}var h,w,y,N=function(){},A=!0,b="http://localhost:3000/api/report",E=[/([a-zA-Z|a-zA-Z\d])+(\.)+(yy|duowan|yystatic|baidu|hiido|qq|baidu|gclick|minisplat|baidustatic|huanjuyun|sina|1931)+(\.)+[A-Za-z]{2,14}/i,/((https|http):\/\/)+([a-zA-Z|a-zA-Z\d])+(\.)+(yy|duowan|yystatic|baidu|hiido|qq|baidu|gclick|minisplat|baidustatic|huanjuyun|sina|1931)+(\.)+[A-Za-z]{2,14}/i,/([a-zA-Z|a-zA-Z\d])+(\.)+(yy|duowan|yystatic|baidu|hiido|qq|baidu|gclick|minisplat|baidustatic|huanjuyun|sina|1931)+(:[0-9]{1,4})+(\.)+[A-Za-z]{2,14}/i,/[a-zA-Z0-9]\:\/\/[a-zA-Z0-9_/]*/i],I=["xss","BAIDU_SSP__wrapper","BAIDU_DSPUI_FLOWBAR"],M=["alert","location"];console||(e.console={log:function(){return!0}});var z={set:function(e,t){var n=new Date;n.setTime(n.getTime()+6e4),document.cookie=e+"="+t+";expires="+n.toGMTString()},get:function(e){for(var t,n=document.cookie.replace(/[ ]/g,"").split(";"),a=0;a<n.length;a++){var i=n[a].split("=");if(e==i[0]){t=i[1];break}}return t}},Z=function(){},R={staticScript:[c,Z],dynamicScript:[l,Z],inlineEvent:[a,Z],lockCallAndApply:[f,Z],iframe:[u,Z],iframeSrc:[g,Z]};N.init=function(e){var t;if("object"===typeof e&&!(length in e)){if(e.rules)for(t in R)e.rules.hasOwnProperty(t)&&"function"==typeof e.rules[t]?R[t][1]=e.rules[t]:e.rules[t]||delete R[t];if(e.reportUrl&&(b=e.reportUrl),e.whitelistUrl&&(h=e.whitelistUrl),!(e.whiteList&&Array.isArray(e.whiteList)&&e.whiteList.length))return;w=e.whiteList}v(),console.log(R)},"function"==typeof define&&define.amd?define("httphijack",[],function(){return N}):e.httphijack=N,"Microsoft Internet Explorer"!=navigator.appName||"MSIE6.0"!=navigator.appVersion.split(";")[1].replace(/[ ]/g,"")&&"MSIE7.0"!=navigator.appVersion.split(";")[1].replace(/[ ]/g,"")&&navigator.appVersion.split(";")[1].replace(/[ ]/g,"")}(window);